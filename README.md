# ココロテン - 感情アメダス 🌤️

人の感情をアメダス（気象観測システム）のように視覚化するWebアプリケーションです。

## 特徴 ✨

- 🎭 **喜怒哀楽の4段階表現**: シンプルでわかりやすい感情分類
- 🌈 **色で表現**: 各感情を四角い色付きブロックで表現
- 📍 **位置情報自動取得**: Geolocation APIで現在地を自動取得
- 🗾 **実際の地図**: OpenStreetMapとLeafletを使用した実際の日本地図
- 💾 **データ永続化**: LocalStorageに自動保存、JSONエクスポート機能
- 🌐 **サーバーモード**: みんなでデータを共有できるAPIサーバー機能
- 🔄 **逆ジオコーディング**: 座標から自動的に地名を取得
- 🎯 **スマートクラスタリング**: ズームアウト時に地域ごとの平均を表示
- 🔍 **段階的表示**: ズームインで個人の感情が徐々に見える
- 💫 **美しいUI**: スムーズなアニメーションと直感的な操作
- 📱 **レスポンシブデザイン**: あらゆるデバイスに対応
- 🚫 **ピンチズーム無効**: マップ操作時にブラウザのズームを防止

## 感情の色分け 🎨

| 感情 | 色コード | アイコン | 説明 |
|------|---------|----------|------|
| 喜 | #049944 | 😊 | うれしい、楽しい、明るい気持ち |
| 怒 | #E60013 | 😠 | いかり、不満、腹立たしい気持ち |
| 哀 | #0169B8 | 😢 | 悲しい、さみしい、つらい気持ち |
| 楽 | #F39801 | 😄 | 楽しい、ワクワク、心地よい気持ち |

## セットアップ 🚀

### 必要な環境
- Node.js 16以上
- npm または yarn

### インストール

#### フロントエンド（必須）

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev

# プロダクションビルド
npm run build

# プレビュー
npm run preview
```

#### バックエンドサーバー（オプション - みんなで共有する場合）

```bash
# サーバーディレクトリへ移動
cd server

# サーバーの依存関係をインストール
npm install --cache /tmp/.npm

# サーバーを起動
npm start
```

詳しくは [README-SERVER.md](./README-SERVER.md) をご覧ください。

## 使い方 📖

1. **地図の確認**: アプリを起動すると、OpenStreetMapの日本地図が表示されます

2. **モード選択**:
   - 💻 **ローカルモード**（デフォルト）: 自分のブラウザだけでデータを管理
   - 🌐 **サーバーモード**: みんなでデータを共有（サーバー起動が必要）
   - 右上の統計パネルで切り替え可能

3. **サンプルデータ生成**:
   - 右上の統計パネルから「🚀 5000人データ生成」をクリック
   - 日本全国の主要都市周辺に5000人分のランダムな感情データが生成されます
   - クラスタリング機能の本格テストに最適！
   - 「100人データ生成」も利用可能（軽量テスト用）

4. **自分の感情を登録**:
   - 右下の大きな「+」ボタンをクリック
   - 名前、感情、強度を入力
   - 「登録する」をクリックすると、自動的に現在地を取得してマップに追加されます

5. **マーカーの確認**: 
   - ズームアウト: 地域ごとの平均感情（大きな四角形、人数に応じてサイズが変化）
   - ズームイン: 個人の感情（小さな四角形、強度に応じてサイズが変化）
   - マーカーをクリックすると詳細情報が表示されます

6. **データの管理**:
   - **ローカルモード**: LocalStorageに自動保存、複数タブ間で同期
   - **サーバーモード**: サーバーに保存、全員で共有（5秒ごとに同期）
   - **⬆️ サーバーへアップロード**: ローカルデータをサーバーに移行（ローカルモード時のみ）
   - **JSONエクスポート**: データをダウンロード可能
   - **JSONインポート**: 保存したJSONファイルを読み込み可能
   - **全データ削除**: すべてのデータをクリア

7. **凡例**: 左下の凡例で各感情の色の意味を確認できます

## 技術スタック 🛠️

- **React 18** - UIライブラリ
- **TypeScript** - 型安全性
- **Vite** - 高速なビルドツール
- **Leaflet** - オープンソース地図ライブラリ
- **React Leaflet** - LeafletのReactラッパー
- **OpenStreetMap** - 地図データ
- **CartoDB Positron** - 軽量な白黒タイルレイヤー
- **Geolocation API** - 位置情報取得
- **LocalStorage** - データ永続化
- **Nominatim API** - 逆ジオコーディング（座標→地名変換）
- **BroadcastChannel API** - 複数タブ間のリアルタイム同期

## プロジェクト構造 📁

```
kokoroten/
├── src/
│   ├── components/              # Reactコンポーネント
│   │   ├── EmotionMap.tsx       # メインの地図コンポーネント
│   │   ├── EmotionMarker.tsx    # 感情マーカー
│   │   ├── EmotionDetail.tsx    # 詳細モーダル
│   │   ├── EmotionLegend.tsx    # 凡例
│   │   ├── AddEmotionButton.tsx # プラスボタン
│   │   └── EmotionInputForm.tsx # 感情入力フォーム
│   ├── types/                   # TypeScript型定義
│   │   └── emotion.ts           # 感情関連の型
│   ├── utils/                   # ユーティリティ
│   │   ├── emotionStorage.ts    # LocalStorage管理
│   │   └── geolocation.ts       # 位置情報取得
│   ├── data/                    # データ管理
│   │   └── mockData.ts          # モックデータ（参考用）
│   ├── App.tsx                  # アプリケーションルート
│   ├── main.tsx                 # エントリーポイント
│   └── index.css                # グローバルスタイル
├── public/
│   └── emotions.json            # データストレージ（JSONフォーマット）
├── index.html                   # HTMLテンプレート
├── package.json                 # 依存関係
├── tsconfig.json                # TypeScript設定
├── vite.config.ts               # Vite設定
└── README.md                    # このファイル
```

## カスタマイズ 🎨

### 感情の種類を追加する

`src/types/emotion.ts` の `EmotionType` と `emotionWeatherMap` を編集してください。

### 観測地点を変更する

`src/data/mockData.ts` の `locations` 配列を編集してください。

### 更新間隔を変更する

`src/components/EmotionMap.tsx` の `setInterval` の値（ミリ秒）を変更してください。

## 主な機能 🎯

### 1. 感情の登録
- 右下の「+」ボタンをクリック
- 名前、感情の種類、強度を入力
- 自動的に現在地を取得してマップに追加

### 2. データの永続化とリアルタイム同期
- **LocalStorageに自動保存**: ブラウザを閉じてもデータが残る
- **リアルタイム同期**: 2秒ごとに自動更新
- **BroadcastChannel API**: 複数タブ間でリアルタイム同期
- **JSONエクスポート**: データファイルのダウンロード
- **JSONインポート**: 保存したデータを読み込み
- **大規模データ生成**: 5000人分のデータを一括生成可能
- **段階的テスト**: 100人版と5000人版を用意

### 3. 位置情報の取得
- ブラウザのGeolocation APIを使用
- 初回アクセス時に位置情報の許可を求めます
- 逆ジオコーディングで地名を自動取得

### 4. インタラクティブな地図
- ズーム、パン操作が可能
- マーカークリックで詳細表示
- ポップアップで簡易情報表示

### 5. スマートクラスタリング
- **ズームアウト時（Zoom 4-11）**: 近隣の感情データを自動的にグループ化
- **地域平均を表示**: 大きな四角形マーカー（人数に応じてサイズが変化）で平均感情を表示
- **ズームイン時（Zoom 12以上）**: 個人の感情を小さな四角形ブロックで表示
- **段階的な表示切替**: 9段階のズームレベルで細かく制御、重なりを防止
- **統一された視覚表現**: 個人も地域平均も四角形で統一

#### クラスタリングの仕組み
- **Zoom 3以下**: 85km圏内をグループ化
- **Zoom 4**: 65km圏内をグループ化
- **Zoom 5**: 48km圏内をグループ化
- **Zoom 6**: 35km圏内をグループ化
- **Zoom 7**: 25km圏内をグループ化
- **Zoom 8**: 18km圏内をグループ化
- **Zoom 9**: 12km圏内をグループ化
- **Zoom 10**: 8km圏内をグループ化
- **Zoom 11**: 5km圏内をグループ化
- **Zoom 12**: 3km圏内をグループ化
- **Zoom 13以上**: 個別表示

## 今後の拡張案 🔮

- [x] バックエンドAPI連携（サーバーモード実装済み✅）
- [x] ピンチズーム無効化（実装済み✅）
- [ ] ユーザー認証機能
- [ ] データベース連携（PostgreSQL, MongoDB等）
- [ ] 感情の時系列グラフ
- [ ] 期間・感情種類でフィルタリング
- [ ] ダークモード
- [ ] 多言語対応
- [ ] ソーシャルシェア機能
- [ ] プッシュ通知
- [ ] WebSocket リアルタイム通信

## ライセンス 📄

MIT License

## 作成者 👨‍💻

ココロテン プロジェクト

---

**ココロテン** - 感情を可視化する、新しい体験を。

